name: Autonomous Achievement & Streak Suite (Daily Stealth)

on:
  schedule:
    - cron: '45 3 * * *' # Every day at 03:45 AM (Randomized time)
  workflow_dispatch: # Allow manual trigger

jobs:
  automation:
    runs-on: ubuntu-latest
    steps:
      - name: Stealth Check (Random Skip)
        run: |
          # 10% chance to skip the daily run to mimic human behavior
          RANDOM_VAL=$((1 + $RANDOM % 10))
          if [ $RANDOM_VAL -eq 1 ]; then
            echo "Stealth skip: Mimicking a day off."
            exit 0
          fi
      - uses: actions/checkout@v4
        with:
          # Use GH_TOKEN for multi-repo access, fallback to GITHUB_TOKEN for local
          token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests --break-system-packages

      - name: Run Multi-Repo Contribution Maintenance
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          USER_NAME: "yani2298"
          USER_EMAIL: "166488970+yani2298@users.noreply.github.com"
        run: |
          # Sequence of repos to keep active
          REPOS=(
            "https://github.com/yani2298/GoGreenPro.git"
            "https://github.com/yani2298/salat-now.git"
            "https://github.com/yani2298/PlayOuran.git"
            "https://github.com/yani2298/MuslimHub.git"
          )
          
          START_DATE=$(date -d "1 day ago" +%Y-%m-%d)
          END_DATE=$(date +%Y-%m-%d)
          
          for repo in "${REPOS[@]}"; do
            echo "::group::Maintaining $repo"
            export REPO_URL=$repo
            # Keep it low: 1-2 commits per repo per day
            python3 github_contribution_booster.py --start $START_DATE --end $END_DATE --freq 2
            echo "::endgroup::"
          done

      - name: Run Achievement Automation (Badges)
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          REPO_URL: "https://github.com/${{ github.repository }}.git"
          USER_NAME: "yani2298"
          USER_EMAIL: "166488970+yani2298@users.noreply.github.com"
        run: |
          # Only run one badge attempt per day to stay safe
          BADGES=("shark" "quick" "pair" "yolo")
          SELECTED_BADGE=${BADGES[$RANDOM % ${#BADGES[@]}]}
          echo "Selected Badge for today: $SELECTED_BADGE"
          
          # For shark, we only do 1 PR per day to spread it out over 16 days
          python3 github_pair_badge.py --badge $SELECTED_BADGE --count 1
